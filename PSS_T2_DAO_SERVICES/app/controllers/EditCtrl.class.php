<?php

namespace app\controllers;

use core\App;
use core\Message;
use core\Utils;
use core\ParamUtils;
use app\forms\EditForm;
use core\SessionUtils;

/**
 * @author Marcel Smarczyk 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 * 
 */
class EditCtrl {

    private $idUser;
    private $userName;
    private $data;
    private $orgs;
    private $pros;
    private $tsks;
    private $idOrg;
    private $ActiveOrg;
    private $ActivePro;
    private $ActiveTsk;
    private $Operation;
    

    public function __construct() {
        //stworzenie potrzebnych obiektów
        $this->form = new EditForm();
    }
    
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



// część ogólna



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////





public function chceckIsOwner(){
    $this->form->organization = ParamUtils::getFromRequest('ActiveOrg',true);
    $this->idUser = SessionUtils::load('userid',true);
    $sqlCheckOwner="select count(*) as isOwner from app_org o 
    where o.CreatedBy = $this->idUser and id=".$this->form->organization;
    $isOwner = App::getDB()->query($sqlCheckOwner)->fetchAll();
    // print_r($isOwner);
    // exit();
    if($isOwner[0]['isOwner'] == 1){
        return true;
    } else{
        return false;
    }

}





public function getOrganizationName($orgId){
    try {
        $this->ActiveOrg = App::getDB()->select(
            "app_org", [
                "id",
                "name"
            ], [
                "id" => $orgId
            ]
        );
            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
}

public function getProjectName($orgId, $proId){
    try {
        $this->ActivePro = App::getDB()->select(
            "app_pro", [
                "id",
                "name"
            ], [
                "idOrg" => $orgId,
                "id" => $proId,
            ]
        );
            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej projektu organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
}















///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



// koniec cześć ogólna



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



// część projektowa 



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////













    public function loadPros(){
        try {
            $this->pros = App::getDB()->select(
                "app_pro", [
                    "app_pro.id",
                    "app_pro.name",
                    "app_pro.idOrg",
                    "app_pro.description",
                    "app_pro.isActive"
                ], [
                    "idOrg" => $this->form->idOrg
                ]
            );

                } catch (\PDOException $e) {
                    Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu projektów organizacji');
                    if (App::getConf()->debug)
                        Utils::addErrorMessage($e->getMessage());
                }
            count($this->pros) == 0 ? $this->pros = 'brak' : null;
    }

	//validacja danych przed wyswietleniem do edycji
	public function validateEditPro() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);

        if (!empty(trim($this->form->ActiveOrg)) && !empty(trim($this->form->ActivePro))) {
            $this->Operation="Edycja Projektu";
            return true;
            
		}
        if (!empty(trim($this->form->ActiveOrg))){
			$this->Operation="Dodawanie Projektu";
            return false;
        }
	}
	

    public function validateSavePro() {

        $this->idUser = SessionUtils::load('userid',true);
        $this->userName = SessionUtils::load('username',true);
        
        
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);
        $this->form->name = ParamUtils::getFromRequest('name',true,'Błędne wywołanie aplikacji');
        $this->form->description = ParamUtils::getFromRequest('description',true,'Błędne wywołanie aplikacji');
        $this->form->status = ParamUtils::getFromRequest('status',false,'Błędne wywołanie aplikacji');




		if (empty(trim($this->form->name))) {
            Utils::addErrorMessage('Nie podano name');
		}
		if (empty(trim($this->form->description))) {
            Utils::addErrorMessage('Nie podano description');
		}

        if (App::getMessages()->isError()) {return false;}

        return true;
    }



    
    public function action_Editpro() {
                
        $this->idUser = SessionUtils::load('userid',true);
        $this->userName = SessionUtils::load('username',true);

        $this->form->idOrg = ParamUtils::getFromGet('idOrg');
        $this->form->idPro = ParamUtils::getFromGet('idPro');
       

            $this->loadOrgs();
            $this->pros='null';
            $this->tsks='null'; 


            if($this->validateEditPro()){
                try {
                    $ProData = App::getDB()->select(
                        "app_pro",[
                            "[>]app_user" => ["CreatedBy"=>"idUser"]
                        ], [
                            "id",
                            "idOrg",
                            "name",
                            "description",
                            "app_pro.CreatedAt",
                            "app_pro.isActive",
                            "login"
                        ], [
                            "id" => $this->form->ActivePro,
                            "idOrg" => $this->form->ActiveOrg
                        ]
                    );
                    $this->form->ActiveOrg = $ProData[0]['idOrg'];
                    $this->form->ActivePro = $ProData[0]['id'];
                    $this->form->name = $ProData[0]['name'];
                    $this->form->description = $ProData[0]['description'];
                    $this->form->CreatedBy = $ProData[0]['login'];
                    $this->form->CreatedAt = $ProData[0]['CreatedAt'];
                    $this->form->status = $ProData[0]['isActive'];
                    
                        } catch (\PDOException $e) {
                            Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                            if (App::getConf()->debug)
                                Utils::addErrorMessage($e->getMessage());
                        }
            } else{
                $this->form->name ="";
                $this->form->description = "";
                $this->form->CreatedBy ="";
                $this->form->CreatedAt = "";
                $this->form->status = 0;
                $this->form->ActivePro="";
            }



            print_r($this->form);
            //exit();


        App::getSmarty()->assign("opr" ,2);
        App::getSmarty()->assign("form" ,$this->form);
        App::getSmarty()->assign("orgs" ,$this->orgs);
        App::getSmarty()->assign("pros" ,$this->pros);
        App::getSmarty()->assign("tsks" ,$this->tsks);
        App::getSmarty()->assign("value",$this->userName);
        App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
        App::getSmarty()->assign("ActivePro",$this->ActivePro);
        App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
        App::getSmarty()->assign("Operation",$this->Operation);
        App::getSmarty()->display("Edit.tpl");
        
    }





    public function action_Editsavepro(){
			
			
		// 1. Walidacja danych formularza (z pobraniem)
        if($this->chceckIsOwner() || $this->chceckHavePermissionToProjects()){
		if ($this->validateSavePro()) {
			// 2. Zapis danych w bazie
			try {
				
                $this->form->status == 1 ? null : $this->form->status = 0;

				//2.1 Nowy rekord
				if ($this->form->ActivePro == '') {
					//sprawdź liczebność rekordów - nie pozwalaj przekroczyć 20
                    $result= App::getDB()->insert("app_pro", [
							"name" => $this->form->name,
							"description" => $this->form->description,
							"isActive" => $this->form->status,
                            "CreatedBy" => $this->idUser,
                            "idOrg" => $this->form->ActiveOrg
						]);
				} else { 
				//2.2 Edycja rekordu o danym ID
                App::getDB()->update("app_pro", [
                        "name" => $this->form->name,
                        "description" => $this->form->description,
                        "isActive" => $this->form->status
					], [ 
						"id" => $this->form->ActivePro
					]);
				
                }


            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
			


			//3b. Po zapisie przejdź na stronę listy osób (w ramach tego samego żądania http)
            App::getRouter()->redirectTo('dashboard&idOrg='.$this->form->ActiveOrg);}
            else{
                App::getRouter()->redirectTo('dashboard&idOrg='.$this->form->ActiveOrg);
            }

		} else {
			// 3c. Gdy błąd walidacji to pozostań na stronie
            App::getSmarty()->assign("opr" ,2);
            App::getSmarty()->assign("form" ,$this->form);
            App::getSmarty()->assign("orgs" ,$this->orgs);
            App::getSmarty()->assign("pros" ,$this->pros);
            App::getSmarty()->assign("tsks" ,$this->tsks);
            App::getSmarty()->assign("value",$this->userName);
            App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
            App::getSmarty()->assign("ActivePro",$this->ActivePro);
            App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
            App::getSmarty()->assign("Operation",$this->Operation);
            App::getSmarty()->display("Edit.tpl");
		}		
	}


    public function validateDeletePro() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);
        if (!empty(trim($this->form->ActiveOrg))  && !empty(trim($this->form->ActivePro))) {
            $this->Operation="Edycja Zadania";
            return true; 
        }
            return false;
        
	}

    public function action_Editdeletepro(){		
		// 1. walidacja id osoby do usuniecia
        if($this->chceckIsOwner() || $this->chceckHavePermissionToProjects()){
		if ( $this->validateDeletePro() ){
			try{
				// 2. usunięcie rekordu
				App::getDB()->delete("app_tsk",[
					"idPro" => $this->form->ActivePro
				]);
                App::getDB()->delete("app_pro",[
					"id" => $this->form->ActivePro
				]);
            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
		}
        App::getRouter()->redirectTo('dashboard&idOrg='.$this->form->ActiveOrg);
    }else{
        App::getRouter()->redirectTo('dashboard&idOrg='.$this->form->ActiveOrg);
    }

		// 3. Przekierowanie na stronę listy osób
	}



    public function chceckHavePermissionToProjects(){
        $this->form->organization = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->idUser = SessionUtils::load('userid',true);
        $sqlCheckOwner="select count(*) as HavePermission from app_user_org uo 
        where uo.idUser = $this->idUser and uo.idOrg=".$this->form->organization." and uo.idRole=5";
        $HavePermission = App::getDB()->query($sqlCheckOwner)->fetchAll();
        // print_r($isOwner);
        // exit();
        if($HavePermission[0]['HavePermission'] == 1){
            return true;
        } else{
            return false;
        }
    }





///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



// koniec część projektowa 



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


// część zadań 



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



    public function loadTsks(){
        try {
            $this->tsks = App::getDB()->select(
                "app_tsk", [
                    "app_tsk.id",
                    "app_tsk.name",
                    "app_tsk.idPro",
                    "app_tsk.description",
                    "app_tsk.status"
                ], [
                    "idPro" => $this->form->idPro
                ]
            );

                } catch (\PDOException $e) {
                    Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu projektów organizacji');
                    if (App::getConf()->debug)
                        Utils::addErrorMessage($e->getMessage());
                }
            count($this->tsks) == 0 ? $this->tsks = 'brak' : null;
            print_r($this->tsks);
    }







	//validacja danych przed wyswietleniem do edycji
	public function validateEditTsk() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);
        $this->form->ActiveTsk = ParamUtils::getFromRequest('ActiveTsk',true);
        if (!empty(trim($this->form->ActivePro))  && !empty(trim($this->form->ActiveTsk))) {
            $this->Operation="Edycja Zadania";
            return true; 
		}
        if (!empty(trim($this->form->ActivePro))){
			$this->Operation="Dodawanie Zadania";
            return false;
        }
	}
	
	public function validateDeleteTsk() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);
        $this->form->ActiveTsk = ParamUtils::getFromRequest('ActiveTsk',true);
        if (!empty(trim($this->form->ActiveOrg))  && !empty(trim($this->form->ActivePro))  && !empty(trim($this->form->ActiveTsk))) {
            $this->Operation="Edycja Zadania";
            return true; 
        }
            return false;
        
	}
	



    public function validateSaveTsk() {

        $this->idUser = SessionUtils::load('userid',true,'Błędne wywołanie aplikacji');
        $this->userName = SessionUtils::load('username',true,'Błędne wywołanie aplikacji');
        
        
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        //exit($this->form->ActiveOrg."- aodascxa" );
        $this->form->ActivePro = ParamUtils::getFromRequest('ActivePro',true);
        $this->form->ActiveTsk = ParamUtils::getFromRequest('ActiveTsk',true);
        $this->form->name = ParamUtils::getFromRequest('name',true,'Błędne wywołanie aplikacji');
        $this->form->description = ParamUtils::getFromRequest('description',true,'Błędne wywołanie aplikacji');
        $this->form->status = ParamUtils::getFromRequest('status',false,'Błędne wywołanie aplikacji');




		if (empty(trim($this->form->name))) {
            Utils::addErrorMessage('Nie podano name');
		}
		if (empty(trim($this->form->description))) {
            Utils::addErrorMessage('Nie podano description');
		}

        if (App::getMessages()->isError()) {return false;}

        return true;
    }



    public function action_EditTsk() {
                
        $this->idUser = SessionUtils::load('userid',true);
        $this->userName = SessionUtils::load('username',true);

        
       

            $this->loadOrgs();
            $this->pros='null';
            $this->tsks='null'; 


            if($this->validateEditTsk()){
                try {
                    $ProData = App::getDB()->select(
                        "app_tsk",[
                            "[>]app_user" => ["CreatedBy"=>"idUser"]
                        ], [
                            "id",
                            "idPro",
                            "name",
                            "description",
                            "app_tsk.CreatedAt",
                            "app_tsk.status",
                            "login"
                        ], [
                            "idPro" => $this->form->ActivePro,
                            "id" => $this->form->ActiveTsk
                        ]
                    );
                    $this->form->ActivePro = $ProData[0]['idPro'];
                    $this->form->ActiveTsk = $ProData[0]['id'];
                    $this->form->name = $ProData[0]['name'];
                    $this->form->description = $ProData[0]['description'];
                    $this->form->CreatedBy = $ProData[0]['login'];
                    $this->form->CreatedAt = $ProData[0]['CreatedAt'];
                    $this->form->status = $ProData[0]['status'];
                    
                        } catch (\PDOException $e) {
                            Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                            if (App::getConf()->debug)
                                Utils::addErrorMessage($e->getMessage());
                        }
            } else{
                $this->form->name ="";
                $this->form->description = "";
                $this->form->CreatedBy ="";
                $this->form->CreatedAt = "";
                $this->form->status = 0;
                $this->form->ActiveTsk="";
            }



    


        App::getSmarty()->assign("opr" ,3);
        App::getSmarty()->assign("form" ,$this->form);
        App::getSmarty()->assign("orgs" ,$this->orgs);
        App::getSmarty()->assign("pros" ,$this->pros);
        App::getSmarty()->assign("tsks" ,$this->tsks);
        App::getSmarty()->assign("value",$this->userName);
        App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
        App::getSmarty()->assign("ActivePro",$this->ActivePro);
        App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
        App::getSmarty()->assign("Operation",$this->Operation);
        App::getSmarty()->display("Edit.tpl");
        
    }





    public function action_EditsaveTsk(){
			
			
		// 1. Walidacja danych formularza (z pobraniem)
		if ($this->validateSaveTsk()) {
			// 2. Zapis danych w bazie
            if($this->chceckIsOwner() || $this->chceckHavePermissionToTasks()){
			try {

				//2.1 Nowy rekord
				if ($this->form->ActiveTsk == '') {
					//sprawdź liczebność rekordów - nie pozwalaj przekroczyć 20
                    $result= App::getDB()->insert("app_tsk", [
							"name" => $this->form->name,
							"description" => $this->form->description,
							"status" => $this->form->status,
                            "CreatedBy" => $this->idUser,
                            "idPro" => $this->form->ActivePro
						]);
				} else { 
				//2.2 Edycja rekordu o danym ID

                $aDate = date('Y-m-d H:i:s');
                App::getDB()->update("app_tsk", [
                        "name" => $this->form->name,
                        "description" => $this->form->description,
                        "status" => $this->form->status,
                        "UpdatedBy" => $this->idUser,
                        "UpdatedAt" => $this->form->$aDate
					], [ 
						"id" => $this->form->ActiveTsk
					]);
				
                }


            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
            }else{
                App::getRouter()->redirectTo('dashboard&idPro='.$this->form->ActivePro.'&idOrg='.$this->form->ActiveOrg);
            }


			//3b. Po zapisie przejdź na stronę listy osób (w ramach tego samego żądania http)
            App::getRouter()->redirectTo('dashboard&idPro='.$this->form->ActivePro.'&idOrg='.$this->form->ActiveOrg);

		} else {
			// 3c. Gdy błąd walidacji to pozostań na stronie
            App::getSmarty()->assign("opr" ,3);
            App::getSmarty()->assign("form" ,$this->form);
            App::getSmarty()->assign("orgs" ,$this->orgs);
            App::getSmarty()->assign("pros" ,$this->pros);
            App::getSmarty()->assign("tsks" ,$this->tsks);
            App::getSmarty()->assign("value",$this->userName);
            App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
            App::getSmarty()->assign("ActivePro",$this->ActivePro);
            App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
            App::getSmarty()->assign("Operation",$this->Operation);
            App::getSmarty()->display("Edit.tpl");
		}		
	}



    public function action_Editdeletetsk(){		
		// 1. walidacja id osoby do usuniecia
        
		if ( $this->validateDeleteTsk() ){
            if($this->chceckIsOwner() || $this->chceckHavePermissionToTasks()){
			try{
				// 2. usunięcie rekordu
				App::getDB()->delete("app_tsk",[
					"id" => $this->form->ActiveTsk
				]);
            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
		}
        App::getRouter()->redirectTo('dashboard&idPro='.$this->form->ActivePro.'&idOrg='.$this->form->ActiveOrg);
        }else{
            App::getRouter()->redirectTo('dashboard&idPro='.$this->form->ActivePro.'&idOrg='.$this->form->ActiveOrg);
        }
		// 3. Przekierowanie na stronę listy osób
	}




    public function chceckHavePermissionToTasks(){
        $this->form->organization = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->idUser = SessionUtils::load('userid',true);
        $sqlCheckOwner="select count(*) as HavePermission from app_user_org uo 
        where uo.idUser = $this->idUser and uo.idOrg=".$this->form->organization." and (uo.idRole = 5 or uo.idRole=4)";
        $HavePermission = App::getDB()->query($sqlCheckOwner)->fetchAll();
        // print_r($isOwner);
        // exit();
        if($HavePermission[0]['HavePermission'] == 1){
            return true;
        } else{
            return false;
        }
    }


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



//koniec część zadań 



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



// część Organizacji



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////











    public function loadOrgs(){
        try {
            $this->orgs = App::getDB()->select(
                "app_user_org", [
                    "[>]app_org" => ["idorg" => "id"]
                ], [
                    "app_org.id",
                    "app_org.name",
                    "app_org.description",
                    "app_user_org.idUser"
                ], [
                    "idUser" => $this->idUser
                ]
            );

                } catch (\PDOException $e) {
                    Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu organizacji');
                    if (App::getConf()->debug)
                        Utils::addErrorMessage($e->getMessage());
                }
    }

	//validacja danych przed wyswietleniem do edycji
	public function validateEditOrg() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);

        if (empty(trim($this->form->ActiveOrg))) {
			$this->Operation="Dodawanie Organizacji";
            return false;
		} else{
            $this->Operation="Edycja Organizacji";
            return true;
        }
	}
	

    public function validateSaveOrg() {

        $this->idUser = SessionUtils::load('userid',true);
        $this->userName = SessionUtils::load('username',true);
        
        
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        $this->form->name = ParamUtils::getFromRequest('name',true,'Błędne wywołanie aplikacji');
        $this->form->description = ParamUtils::getFromRequest('description',true,'Błędne wywołanie aplikacji');
        $this->form->status = ParamUtils::getFromRequest('status',false,'Błędne wywołanie aplikacji');




		if (empty(trim($this->form->name))) {
            Utils::addErrorMessage('Nie podano name');
		}
		if (empty(trim($this->form->description))) {
            Utils::addErrorMessage('Nie podano description');
		}

        if (App::getMessages()->isError()) {return false;}

        return true;
    }



    public function action_Editorg() {
                
        $this->idUser = SessionUtils::load('userid',true);
        $this->userName = SessionUtils::load('username',true);

        $this->form->idOrg = ParamUtils::getFromGet('idOrg');
        $this->form->idPro = ParamUtils::getFromGet('idPro');
       

            $this->loadOrgs();
            $this->pros='null';
            $this->tsks='null'; 


            if($this->validateEditOrg()){
                try {
                    print "aktyw org".$this->form->ActiveOrg;
                    $OrgData = App::getDB()->select(
                        "app_org",[
                            "[>]app_user" => ["CreatedBy"=>"idUser"]
                        ], [
                            "id",
                            "name",
                            "description",
                            "app_org.CreatedAt",
                            "app_org.isActive",
                            "login"
                        ], [
                            "id" => $this->form->ActiveOrg
                        ]
                    );
                    $this->form->ActiveOrg = $OrgData[0]['id'];
                    $this->form->name = $OrgData[0]['name'];
                    $this->form->description = $OrgData[0]['description'];
                    $this->form->CreatedBy = $OrgData[0]['login'];
                    $this->form->CreatedAt = $OrgData[0]['CreatedAt'];
                    $this->form->status = $OrgData[0]['isActive'];
                        } catch (\PDOException $e) {
                            Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                            if (App::getConf()->debug)
                                Utils::addErrorMessage($e->getMessage());
                        }
            }
        App::getSmarty()->assign("opr" ,1);
        App::getSmarty()->assign("form" ,$this->form);
        App::getSmarty()->assign("orgs" ,$this->orgs);
        App::getSmarty()->assign("pros" ,$this->pros);
        App::getSmarty()->assign("tsks" ,$this->tsks);
        App::getSmarty()->assign("value",$this->userName);
        App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
        App::getSmarty()->assign("ActivePro",$this->ActivePro);
        App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
        App::getSmarty()->assign("Operation",$this->Operation);
        App::getSmarty()->display("Edit.tpl");
        
    }





    public function action_Editsaveorg(){
			
		// 1. Walidacja danych formularza (z pobraniem)
		if ($this->validateSaveOrg()) {
			// 2. Zapis danych w bazie
			try {
				
                $this->form->status == 1 ? null : $this->form->status = 0;

				//2.1 Nowy rekord
				if ($this->form->ActiveOrg == '') {
					//sprawdź liczebność rekordów - nie pozwalaj przekroczyć 20
                    $result= App::getDB()->insert("app_org", [
							"name" => $this->form->name,
							"description" => $this->form->description,
							"isActive" => $this->form->status,
                            "CreatedBy" => $this->idUser
						]);
				} else { 
				//2.2 Edycja rekordu o danym ID
                if($this->chceckIsOwner()){
                    App::getDB()->update("app_org", [
                        "name" => $this->form->name,
                        "description" => $this->form->description,
                        "isActive" => $this->form->status
					], [ 
						"id" => $this->form->ActiveOrg
					]);
                }



				
                }


            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
			


			//3b. Po zapisie przejdź na stronę listy osób (w ramach tego samego żądania http)
            App::getRouter()->redirectTo('dashboard');

		} else {
			// 3c. Gdy błąd walidacji to pozostań na stronie
            App::getSmarty()->assign("opr" ,1);
            App::getSmarty()->assign("form" ,$this->form);
            App::getSmarty()->assign("orgs" ,$this->orgs);
            App::getSmarty()->assign("pros" ,$this->pros);
            App::getSmarty()->assign("tsks" ,$this->tsks);
            App::getSmarty()->assign("value",$this->userName);
            App::getSmarty()->assign("ActiveOrg" ,$this->ActiveOrg);
            App::getSmarty()->assign("ActivePro",$this->ActivePro);
            App::getSmarty()->assign("ActiveTsk",$this->ActiveTsk);
            App::getSmarty()->assign("Operation",$this->Operation);
            App::getSmarty()->display("Edit.tpl");
		}		
	}
    

    public function validateDeleteOrg() {
		//pobierz parametry na potrzeby wyswietlenia danych do edycji
		//z widoku listy osób (parametr jest wymagany)
		$this->form->ActiveOrg = ParamUtils::getFromRequest('ActiveOrg',true);
        if (!empty(trim($this->form->ActiveOrg))) {
            $this->Operation="Edycja Zadania";
            return true; 
        }
            return false;
        
	}

    public function action_Editdeleteorg(){		
		// 1. walidacja id osoby do usuniecia
		if ( $this->validateDeleteOrg() ){
            if($this->chceckIsOwner()){
			try{

                //get all pros of org
                $sqlpro = "select id from app_pro where idOrg = ".$this->form->ActiveOrg;

                $pro = App::getDB()->query($sqlpro)->fetchAll();

                foreach ($pro as $row) {
                    App::getDB()->delete("app_tsk",[
                        "idPro" => $row['id']
                    ]);
                    App::getDB()->delete("app_pro",[
                        "id" => $row['id']
                    ]);
                }
				// 2. usunięcie rekordu
				App::getDB()->delete("app_org",[
					"id" => $this->form->ActiveOrg
				]);

            } catch (\PDOException $e) {
                Utils::addErrorMessage('Wystąpił nieoczekiwany błąd w pobieraniu nazwy aktualnej organizacji');
                if (App::getConf()->debug)
                    Utils::addErrorMessage($e->getMessage());
            }
		}
        App::getRouter()->redirectTo('dashboard');
    }else{
        App::getRouter()->redirectTo('dashboard');
    }
		// 3. Przekierowanie na stronę listy osób
	}


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



//koniec część Organizacji



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
